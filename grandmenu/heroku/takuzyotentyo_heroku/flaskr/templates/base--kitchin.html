<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <!-- スマホでtouchイベントの処理を早くするためのメタタグ -->
  <meta name="viewport" content="width=device-width">
  <title>Ground Menu.com</title>
  <link rel="stylesheet" href="../static/css/normalize.css">
  <link rel="stylesheet" href="../static/css/reset.css">
  <link rel="stylesheet" href="../static/scss/style.css">
  <script src="../static/js/jquery-3.4.1.min.js"></script>
  <script src="../static/js//jQuery UI - v1.11.3 - 2015-02-12.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.min.js"></script>
  <script type="text/javascript" src="../static/js/jquery.qrcode.min.js"></script>

  <!-- スマホでsortableを実装するためのライブラリ -->
  <script src="../static/js/jquery.ui.touch-punch.min.js"></script>
  <script src="../static/js/script.js"></script>
</head>

<body>
<script type="text/javascript">
  $(document).ready(function() {

    var socket = io.connect('http://127.0.0.1:5000');

    // 'connect'はクライアント側からサーバー側と繋ぐための特別なイベントで、勝手に行われる
    socket.on('connect', function() {
      // lightbox--ws_errorがvisibleということは、一旦conecctが完了した後に、エラーで接続が切れ、再度connectの処理が必要になったということ
      if($(".lightbox--ws_error").is(':visible')) {
        socket.emit("reload");
      }else{
        $(".lightbox--ws_error").css('display','flex')
        socket.emit("kitchin_infomation","client has connected");
      };
    });

    socket.on('reload', function(){
      location.reload();
    });

    // 特に意味無し
    socket.on('server_to_client_connection', function(msg){
      console.log(msg);
    });

    // テーブルアクティベートに関する処理
    $(document).on("click", ".table_activate__checkbox", function () {
      // table_numberを取得
      var table_number = $(this).attr("id").replace("table_", "");
      // チェックボックスにすでにチェックが入っているかと、ポップアップウィンドウの回答によって、activate_statusに変数を入れる
      if($(this).prop("checked") == true) {
        if(confirm("テーブルアクティベートを行いますか？")){
          // OK時の処理
          // チェックボックスが動いてしまうけど、その後の処理の流れで、他のユーザーのチェックボックスも動くので問題ない
          var activate_status = 1
          // ランダムな文字列(one_time_password)を作成
          var str = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
          //桁数の定義
          var len = 16;
          //ランダムな文字列の生成
          var one_time_password = "";
          for(var i=0;i<len;i++){
            one_time_password += str.charAt(Math.floor(Math.random() * str.length));
          }
        }else{
          // キャンセルをした場合、チェックボックスを戻す
          $(this).prop("checked", false);
        };
      }else{
        if(confirm("会計が終わっていないお客様がいらっしゃる可能性があります。\n本当にOFFにしますか？")){
          // OK時の処理
          // チェックボックスが動いてしまうけど、その後の処理の流れで、他のユーザーのチェックボックスも動くので問題ない
          var activate_status = 0
          one_time_password = null;
        }else{
          // キャンセルをした場合、チェックボックスを戻す
          $(this).prop("checked", true);
        };
      };
      // activate_statusが設定されていない場合、"null"ではなく、"undifined"になるので、一応チェック(デバック用なので、消してよし)
      console.log("activate_status")
      console.log(activate_status)
      console.log(one_time_password)
      // activate_statusが変数として存在しているかチェックし、していなければemitでサーバーに送る処理を回避する
      if(typeof activate_status != "undefined"){
        var table_status = {
          "table_number": table_number,
          "activate_status": activate_status,
          "one_time_password": one_time_password
        };
        socket.emit("table_activate", table_status);
      };
    });

    // table_activateを反映する処理
    socket.on('table_activate', function(table_status){
      console.log("table_activateを実行します")
      var table_number = table_status['table_number']
      var table_number_obj = $("#table_" + table_status['table_number'])
      var activate_status = table_status['activate_status']
      var one_time_password =  table_status['one_time_password']
      // 実際にチェックを入れたユーザーをorigin_userとする(origin_userの場合、前の工程でチェックを入れているので、trueが入る)
      var origin_user = table_number_obj.prop("checked")
      console.log(origin_user)
      // チェックボックスを動かす処理
      if(activate_status == 1){
        table_number_obj.prop("checked", true);
        table_number_obj.parent().next(".text__body").css("visibility","visible")
        $('.wrapper--qrcode').append('<div id="container_qrcode_'+table_number+'" data-target="qrcode_'+table_number+'" data-one_time_password="'+one_time_password+'"></div>')
        $("#container_qrcode_" + table_number)
          .append('<div class="text__title">Table ' + table_number + '</div>')
          .append('<span id="qrcode_' + table_number +'"></span>')
        $("#qrcode_" + table_number).qrcode(one_time_password);
        if(origin_user == true){
          $(".lightbox").children().css("display","none");
          $(".wrapper--qrcode").children().css("display", "none")
          $(".wrapper--qrcode").css("display","");
          $("#container_qrcode_" + table_number).css("display", "")
          $(".lightbox").css("display","flex")
          $('[data-target="lightbox_always_show"]').css("display", "");
          $(".lightbox").animate({left:"0%"}, 250);
        };
      }else{
        table_number_obj.prop("checked", false);
        table_number_obj.parent().next(".text__body")
          .css("visibility","hidden")
          .text('QR確認 >')
        table_number_obj.parent().parent().removeClass('bound')
        $("#container_qrcode_" + table_number).remove();
      };
    });

    socket.on('show_order', function(data){
      if(data['action']=="show"){
        $(".order_list__wrap").empty();
      };
      var len = data['order_list'].length;
      var order_list = data['order_list']
      // 以下の処理で、order_listをHTML内に組み込む
      for (var i=0; i<len; i++) {
        var order_id = order_list[i][0]
        var class_1 = order_list[i][1]
        var class_2 = order_list[i][2]
        var class_3 = order_list[i][3]
        var table_number = order_list[i][4]
        var quantity = order_list[i][5]
        $(".order_list__wrap")
          .append('<li class="menu_box--order" id="order_id_'+order_id+'"></li>');
        $('#order_id_' + order_id)
          .append('<span class="menu_box--order__class_2">'+class_2+'</span>')
          .append('<span class="menu_box--order__class_3">'+class_3+'</span>')
          .append('<span class="menu_box--order__table">Table '+table_number+'</span>')
          .append('<span class="menu_box--order__quantity_label">数量</span>')
          .append('<span class="menu_box--order__quantity">'+quantity+'<span>')
          .append('<span class="menu_box--order__order_check"></span>')
          .append('<span class="menu_box--order__order_cansel">キャンセル</span>')
      };
    });

    $(document).on("click", ".menu_box--order__order_check", function () {
      var menu = $(this).siblings(".menu_box--order__class_3").text()
      var quantity = $(this).siblings(".menu_box--order__quantity").text()
      var order_id = $(this).parent().attr("id").replace("order_id_", "")
      var order_status = 3
      // アラートを出して、調理完了を確認
      if(confirm(menu + quantity + "個の調理を完了しましたか？")){
        // OKの時の処理
        socket.emit("order_status_change", {'order_id': order_id, 'order_status':order_status});
      }else{
        // キャンセルの時の処理(何もしない)
      };
    });

    $(document).on("click", ".menu_box--order__order_cansel", function () {
      var menu = $(this).siblings(".menu_box--order__class_3").text()
      var quantity = $(this).siblings(".menu_box--order__quantity").text()
      var order_id = $(this).parent().attr("id").replace("order_id_", "")
      var order_status = 4
      // アラートを出して、キャンセルするかを確認
      if(confirm("本当に" + menu + quantity + "個の調理をキャンセルしますか？")){
        // OKの時の処理
        socket.emit("order_status_change", {'order_id': order_id, 'order_status':order_status});
      }else{
        // キャンセルの時の処理(何もしない)
      };
    });

    socket.on('order_check', function(order_id){
      $('#order_id_' + order_id).remove()
    });

    socket.on('checkout_for_kitchin', function(checkout){
      console.log('test')
      // var table_number = checkout['table_number']
      var table_number = 1
      var total_fee = checkout['total_fee']
      var table_number_obj = $('#table_' + table_number).parent().parent()
      var change_text_obj = $('#table_' + table_number).parent().siblings('.js-show__qrcode')
      table_number_obj.addClass('bound')
      change_text_obj.text('会計表示 >')
      $('#container_qrcode_' + table_number).append('<div class="text__title">会計 ¥ ' + total_fee + '</div>')

    });

    socket.on('error', function(){
    console.log("接続エラー")
    $(".lightbox--ws_error").css('left','0')
    });
  });
</script>

  <div class="background_color">
    <div class="wrapper--header">
      <div class="header__menu js-header__menu icon_menu">
        <!-- メニューの三本線に使う -->
      <span></span>
      <span></span>
      <span></span>
      </div>
    <a href="/" class="header__title">Ground Menu.com</a>
  </div>

<!-- サイドメニュー -->
    <ul class="wrapper--side">

      <li class="side_menu_1">
        <div class="side_menu_1__content">オーダーシステム</div>
        <div class="js-side_menu_1__opener icon_pulus">
          <span></span>
          <span></span>
        </div>
      </li>

      <ul class="side_menu_2">
        <li><a class="side_menu_2__content" href="/show_menu">メニュー表登録・修正</a></li>
        <li><a class="side_menu_2__content" href="/qrcode/generate">QRコード発行</a></li>
        <li><a class="side_menu_2__content" href="/activate">テーブルアクティベート</a></li>
      </ul>

      <li class="side_menu_1">
        <div class="side_menu_1__content">設定</div>
        <div class="js-side_menu_1__opener icon_pulus">
          <span></span>
          <span></span>
        </div>
      </li>

      <ul class="side_menu_2">
        <li><a class="side_menu_2__content" href="/store_setting">店舗情報</a></li>
        <li><a class="side_menu_2__content" href="#">従業員情報</a></li>
      </ul>

      <a class="side_menu__logout" href="/logout">ログアウト</a>
    </ul>

<!-- メインメニュー -->
    <div class="wrapper--main">
  {% block global_navi %}{% endblock %}
    <div class="lightbox--ws_error">
      <div class="lightbox--ws_error__wi-fi"></div>
      <div class="lightbox--ws_error__msg text__subtitle">接続エラーが発生しました</div>
    </div>
    </div>
  </div>
</body>

</html>
